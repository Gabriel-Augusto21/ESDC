{% extends 'master.html' %}
{% load static %}
{% block conteudo %}
<style>
    .desativar-btn,
    .ativar-btn,
    .desativar,
    .editar-dieta-btn,
    .editar-imagem-btn {
        position: absolute;
        width: 22px;
        height: 22px;
        cursor: pointer;
        filter: brightness(0) invert(1);
        opacity: 0.8;
        transition: opacity 0.2s;
        background: transparent;
        border: none;
        padding: 0;
    }

    .desativar-btn {
        bottom: 8px;
        right: 35px;
    }

    .ativar-btn {
        bottom: 10px;
        right: 10px;
    }

    .desativar {
        bottom: 10px;
        right: 70px;
        border: none;
        z-index: 10;
    }

    .editar-imagem-btn {
        bottom: 10px;
        right: 40px;
        z-index: 10;
    }

    .editar-dieta-btn {
        bottom: 10px;
        right: 10px;
    }
</style>
<div class="container mt-3">
    <h1>Animais</h1>

    <!-- Formulário de busca -->
    <form method="get" class="form-group my-4 d-flex justify-content-center mx-auto">
        <div class="col-8 col-lg-4">
            <div class="input-group">
                <input class="form-control" id="txtBuscaNomeAlimento" name="query" value="{{ query }}" type="text"
                    placeholder="Informe o nome de um animal..." style="border-radius: 20px 0 0 20px;">
                <div class="input-group-append">
                    <button type="submit" class="botao" style="border-radius: 0 20px 20px 0;">
                        <img src="{% static 'img/search.png' %}" width="20"
                            style=" margin-right: 3px; filter: brightness(0) invert(1)">
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- Botão de inserir -->
    <div class="form-group row mr-1 justify-content-end">
        <button type="button" class="botao" id="inserir-btn">
            <img src="{% static 'img/add_circle.png' %}" width="20"
                style="margin-right: 3px; filter: brightness(0) invert(1)">
            Inserir
        </button>
    </div>

    <div class="row">
        <!-- Contador de registros -->
        <legend class="text-center small">
            {% if page_obj.paginator.count == 0 %}
            <img src="{% static 'img/sadhorse.png' %}" width="250" height="200" style="padding-bottom: 7px" />
            <h3 class="text-center">Nenhum animal encontrado.</h3>
        </legend>
        {% elif page_obj.paginator.count == 1 %}
        1 animal encontrado
        <div class="container text-center">
            <div class="row">
                {% include 'animais_table.html' %}
            </div>

            {% include "paginador.html" %}
        </div>
        </legend>
        {% else %}
        {{ page_obj.paginator.count }} animais registrados
        <div class="container text-center">
            <div class="row">
                {% include 'animais_table.html' %}
            </div>
            {% include "paginador.html" %}
        </div>
        </legend>
        {% endif %}
    </div>
</div>

<!-- modal inserir -->
<div hidden class="container my-3" style="text-align: start;" id="modalInserir">
    <div class="row mb-4">
        <div class="col-md-6">
            <label for="nomeAnimal" class="form-label">Nome do animal</label>
            <input type="text" class="form-control custom-input" id="nomeAnimal" name="nome" required>
        </div>
        <div class="col-md-6">
            <label for="proprietarioAnimal" class="form-label">Proprietário</label>
            <input type="text" class="form-control custom-input" id="proprietarioAnimal" name="proprietario">
        </div>
        <div class="col-md-6">
            <label for="pesoAnimal" class="form-label">Peso</label>
            <input type="number" step="0.01" class="form-control custom-input" id="pesoAnimal" name="peso_vivo"
                required>
        </div>
        <div class="col-md-6">
            <label for="dataNascAnimal" class="form-label">Data de nascimento</label>
            <input type="date" class="form-control custom-input" id="dataNascAnimal" name="data_nasc" required>
        </div>
        <div class="col-md-6">
            <label for="generoAnimal" class="form-label">Gênero</label>
            <select class="form-select custom-select" id="generoAnimal" name="genero" required>
                <option value="">Selecione o gênero</option>
                <option value="M">Macho</option>
                <option value="F">Fêmea</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="imagemAnimal" class="form-label">Foto do animal</label>
            <input type="file" id="imagemAnimal" name="imagem" accept="image/*">
        </div>
    </div>
</div>


<div hidden class="container my-3" style="text-align: start;" id="modalAtualizar">
    <hr>
    <div class="row my-5">
        <!-- Imagem do Animal -->
                <div class="col-12 col-md-5 mb-3 mb-md-0 d-flex justify-content-center">
            <div id="infoAnimal" class="card position-relative h-100 shadow-lg"
                style="border:none; border-radius: 15px;">
                <img src="" alt="cavalo" id="idVisual" class="card-img"
                    style="height: 280px; object-fit: cover; border-radius: 15px;">
                <div class="card-img-overlay d-flex flex-column justify-content-end"
                    style="background: linear-gradient(to top, rgba(0,0,0,0.69), rgba(0,0,0,0)); height: 280px; color: white; border-radius: 15px; pointer-events: none;">
                </div>
                <img class="desativar" id="desativar-btn" src="{% static 'img/not_visibility.png' %}" width="20">
                <img src="{% static 'img/image-up.png' %}" alt="Editar" class="editar-imagem-btn"
                    style="pointer-events:none">
                <img src="{% static 'img/wheat-off.png' %}" alt="Editar" class="editar-dieta-btn" id="gerenciar-dieta">

            </div>
        </div>

        <!-- Nome do Animal -->
        <div class="col-12 col-md-7 mb-3 mb-md-0" style="text-align: start;">
            <label for="txtNome" class="form-label">Nome do Animal:</label>
            <input id="txtNome" class="form-control" type="text" maxlength="45" required>

            <label for="txtProprietario" class="form-label mt-3">Nome do Propietário:</label>
            <input id="txtProprietario" class="form-control" type="text" placeholder="tem que puxar do banco..."
                maxlength="45">

            <label for="idGenero" class="form-label mt-3">Gênero:</label>
            <select class="form-control" id="idGenero" required>
                <option value="M">Macho</option>
                <option value="F">Fêmea</option>
            </select>

            <div class="row">
                <div class="col">
                    <label for="txtPeso" class="form-label mt-3">Peso:</label>
                    <input id="txtPeso" class="form-control" type="txt" placeholder="tem que puxar do banco..."
                        maxlength="45" required>
                </div>

                <div class="col">
                    <label for="dataNasc" class="form-label mt-3">Data de Nascimento:</label>
                    <input id="dataNasc" class="form-control" type="date" placeholder="tem que puxar do banco..."
                        maxlength="45" required>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module" src="{% static 'js/atualizar_animais.js' %}"></script>

<script>
    window.urlAtualizarAnimal = "{% url 'animais:atualizar_animal' %}";
    const csrf_token = '{{ csrf_token }}';
    document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = csrf_token;
    });
    document.addEventListener('DOMContentLoaded', function () {
        const botaoDieta = document.getElementById('gerenciar-dieta');

        botaoDieta.addEventListener('click', function () {
            const animalId = this.getAttribute('data-animal-id');

            fetch(`/api/animal/${animalId}/dieta_atual/`)
                .then(response => response.json())
                .then(data => {
                    if (data.tem_dieta) {
                        // ✅ Já tem dieta atual → vai pra página da dieta
                        window.location.href = `/dieta/${animalId}/gerencia_dietas/`;
                    } else {
                        // ❌ Não tem dieta → vai pra página de criar nova dieta
                        window.location.href = `/dieta/${animalId}/inserir_dietas/`;
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar dieta:', error);
                    alert('Não foi possível verificar a dieta do animal.');
                });
        });
    });

    window.csrf_token = '{{ csrf_token }}';
</script>
{% endblock %}