{% extends 'master.html' %}
{% load static %}
{% block conteudo %}

<div class="container mt-3">
  <h1>Cadastrar Nova Dieta</h1>

  <form id="form-dieta" method="post" action="">
    {% csrf_token %}
    <div class="row mt-4">
      <div class="col-md-6 mb-3">
        <label class="form-label">Nome da Dieta</label>
        <input class="form-control" name="nome" required>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Exigência</label>
        <select class="form-control" name="exigencia" required>
          <option value="" disabled selected>Selecione</option>
          {% for ex in exigencias %}
          <option value="{{ ex.id }}">{{ ex.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Descrição</label>
      <textarea class="form-control" name="descricao" rows="2"></textarea>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="especifica">
      <label class="form-check-label">Dieta específica para animais</label>
    </div>

    <hr>

    <div class="row">
      <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">Alimentos da Dieta</h4>
          <button type="button" class="btn btn-sm btn-primary" id="abrirModal">
            <i class="bi bi-plus-circle"></i> Adicionar Alimento
          </button>
        </div>

        <div id="tabela_dieta">
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Alimento</th>
                <th style="width: 150px;">Quantidade (kg)</th>
                <th style="width: 80px;">Ação</th>
              </tr>
            </thead>
            <tbody id="lista-alimentos">
              <tr>
                <td colspan="3" class="text-center text-muted">Nenhum alimento adicionado</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-success text-white py-2">
            <strong>Resumo Nutricional</strong>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Nutriente</th>
                    <th>Fornecido</th>
                    <th>Exigido</th>
                    <th>Dif.</th>
                  </tr>
                </thead>
                <tbody id="tabela-resumo">
                  <tr>
                    <td colspan="4" class="text-center text-muted small">
                      Selecione a exigência e adicione alimentos
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-end mt-4">
      <a href="{% url 'dietas:dietas' %}" class="btn btn-secondary me-2">Cancelar</a>
      <button type="submit" class="btn btn-success">Criar Dieta</button>
    </div>
  </form>
</div>

<!-- passa os dados do Django para o JS-->
<script>
  window.ALIMENTOS_JSON = JSON.stringify({{ alimentos|safe }});
  window.URL_BALANCEAMENTO = "{% url 'dietas:calcular_balanceamento_dinamico' %}";
  window.CSRF_TOKEN = "{{ csrf_token }}";
</script>

<script type="module" src="{% static 'js/inserir_dietas.js' %}"></script>

<!-- tive que fazer isso pra poder puxar os alimentos pro select -->
<script>
  window.ALIMENTOS_JSON = JSON.stringify([
    {% for ali in alimentos %}
      { "id": {{ ali.id }}, "nome": "{{ ali.nome }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]);
  window.URL_BALANCEAMENTO = "{% url 'dietas:calcular_balanceamento_dinamico' %}";
  window.CSRF_TOKEN = "{{ csrf_token }}";
</script>


{% endblock %}
